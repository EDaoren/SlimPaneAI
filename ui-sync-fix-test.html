<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UI同步问题修复测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }
        .problem-section {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            padding: 25px;
            margin: 25px 0;
            border-radius: 12px;
            border-left: 5px solid #e74c3c;
        }
        .solution-section {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            padding: 25px;
            margin: 25px 0;
            border-radius: 12px;
            border-left: 5px solid #27ae60;
        }
        .test-section {
            background: linear-gradient(135deg, #d299c2 0%, #fef9d7 100%);
            padding: 25px;
            margin: 25px 0;
            border-radius: 12px;
            border-left: 5px solid #3498db;
        }
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            font-family: 'Fira Code', 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            border: 1px solid #4a5568;
        }
        .highlight {
            background: #fff3cd;
            padding: 3px 6px;
            border-radius: 4px;
            font-weight: bold;
            color: #856404;
        }
        .badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin: 2px;
        }
        .badge.critical { background: #e74c3c; color: white; }
        .badge.fixed { background: #27ae60; color: white; }
        .badge.test { background: #3498db; color: white; }
        .step-list {
            counter-reset: step-counter;
            list-style: none;
            padding: 0;
        }
        .step-list li {
            counter-increment: step-counter;
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
            position: relative;
        }
        .step-list li::before {
            content: counter(step-counter);
            position: absolute;
            left: -15px;
            top: 15px;
            background: #007bff;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .before, .after {
            padding: 20px;
            border-radius: 8px;
        }
        .before {
            background: #fff5f5;
            border: 2px solid #fed7d7;
        }
        .after {
            background: #f0fff4;
            border: 2px solid #c6f6d5;
        }
        h1 { color: #2c3e50; }
        h2 { color: #34495e; }
        h3 { color: #7f8c8d; }
        .emoji { font-size: 1.2em; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><span class="emoji">🔧</span> UI同步问题修复测试指南</h1>
            <p>解决外观设置中的跨设置UI状态污染问题</p>
        </div>

        <div class="problem-section">
            <h2><span class="emoji">🐛</span> 问题描述</h2>
            <p><strong>核心问题：</strong>在随机切换多个外观配置后，点击某个特定设置时，其他设置的视觉状态会意外更新，但不会触发实际的配置更改处理器。</p>
            
            <h3>具体表现：</h3>
            <ol>
                <li>随机/不规律地切换不同的外观设置</li>
                <li>点击字体大小选项</li>
                <li><span class="highlight">预期：</span>只有字体大小应该改变</li>
                <li><span class="highlight">实际：</span>语言和消息密度按钮视觉上更新了活动状态，但处理器未触发</li>
            </ol>

            <div class="comparison">
                <div class="before">
                    <h4><span class="emoji">❌</span> 修复前</h4>
                    <ul>
                        <li>UI状态基于 <code>userPreferences?.settingName</code></li>
                        <li>响应式语句在每次更新时触发</li>
                        <li>跨设置状态污染</li>
                        <li>幻影UI更新</li>
                    </ul>
                </div>
                <div class="after">
                    <h4><span class="emoji">✅</span> 修复后</h4>
                    <ul>
                        <li>UI状态基于 <code>localUIState.settingName</code></li>
                        <li>立即更新本地状态</li>
                        <li>设置间完全隔离</li>
                        <li>精确的UI控制</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="solution-section">
            <h2><span class="emoji">🛠️</span> 修复方案</h2>
            
            <h3><span class="badge fixed">核心修复</span> UI状态隔离机制</h3>
            <p>引入了 <code>localUIState</code> 对象来管理UI状态，与实际的 <code>userPreferences</code> 分离：</p>
            
            <div class="code-block">
// UI状态隔离 - 用于防止跨设置UI状态污染
let localUIState = {
  theme: '',
  language: '',
  fontSize: '',
  messageDensity: ''
};

// 同步本地UI状态 - 只在非更新状态下同步，避免冲突
$: if (userPreferences && !isUpdatingSettings) {
  localUIState = {
    theme: userPreferences.theme || '',
    language: userPreferences.language || '',
    fontSize: userPreferences.fontSize || '',
    messageDensity: userPreferences.messageDensity || ''
  };
}
            </div>

            <h3><span class="badge fixed">立即更新</span> 防止UI闪烁</h3>
            <p>在 <code>updateSetting</code> 函数中立即更新本地UI状态：</p>
            
            <div class="code-block">
async function updateSetting(key: string, value: any, applyImmediately = false) {
  // 立即更新本地UI状态，防止UI闪烁
  localUIState = {
    ...localUIState,
    [key]: value
  };
  
  // 然后进行实际的设置更新...
}
            </div>

            <h3><span class="badge fixed">UI绑定更新</span> 使用本地状态</h3>
            <p>所有按钮的活动状态现在基于 <code>localUIState</code> 而不是 <code>userPreferences</code>：</p>
            
            <div class="code-block">
<!-- 修复前 -->
class="theme-option {userPreferences?.theme === 'light' ? 'theme-option-active' : ''}"

<!-- 修复后 -->
class="theme-option {localUIState.theme === 'light' ? 'theme-option-active' : ''}"
            </div>
        </div>

        <div class="test-section">
            <h2><span class="emoji">🧪</span> 测试步骤</h2>
            
            <h3><span class="badge test">步骤 1</span> 基础隔离测试</h3>
            <ol class="step-list">
                <li>重新加载扩展并打开配置页面</li>
                <li>进入"外观"设置页面</li>
                <li>点击任意主题选项，观察只有主题按钮状态改变</li>
                <li>点击任意语言选项，观察只有语言按钮状态改变</li>
                <li>点击任意字体大小，观察只有字体按钮状态改变</li>
                <li>点击任意消息密度，观察只有密度按钮状态改变</li>
            </ol>

            <h3><span class="badge test">步骤 2</span> 跨设置污染测试</h3>
            <ol class="step-list">
                <li>随机快速切换主题：浅色→深色→自动→浅色</li>
                <li>立即点击字体大小"大"</li>
                <li><strong>验证：</strong>只有字体大小按钮应该变为活动状态</li>
                <li>语言和消息密度按钮应该保持原状态</li>
                <li>重复测试其他设置组合</li>
            </ol>

            <h3><span class="badge test">步骤 3</span> 快速连续操作测试</h3>
            <ol class="step-list">
                <li>快速连续点击：主题→语言→字体→密度→主题</li>
                <li>每次点击间隔约0.5秒</li>
                <li><strong>验证：</strong>每次只有对应的按钮状态改变</li>
                <li>不应该出现多个按钮同时活动的情况</li>
                <li>不应该出现按钮状态滞后或错误的情况</li>
            </ol>

            <h3><span class="badge test">步骤 4</span> 控制台验证</h3>
            <ol class="step-list">
                <li>打开浏览器开发者工具</li>
                <li>在进行设置更改时观察控制台输出</li>
                <li>应该看到清晰的日志序列：</li>
            </ol>
            
            <div class="code-block">
🔧 [Options] Updating setting: fontSize = large
✅ [Options] Setting fontSize updated successfully
            </div>
            
            <p>不应该看到其他设置的意外更新日志。</p>
        </div>

        <div class="solution-section">
            <h2><span class="emoji">✅</span> 成功标准</h2>
            
            <div class="comparison">
                <div class="before">
                    <h4><span class="emoji">🎯</span> UI隔离</h4>
                    <ul>
                        <li>点击任何设置只影响该设置的UI</li>
                        <li>其他设置的视觉状态保持不变</li>
                        <li>无跨设置UI状态污染</li>
                    </ul>
                </div>
                <div class="after">
                    <h4><span class="emoji">⚡</span> 响应性能</h4>
                    <ul>
                        <li>UI状态立即更新，无闪烁</li>
                        <li>设置更改流畅响应</li>
                        <li>无延迟或滞后现象</li>
                    </ul>
                </div>
            </div>

            <h3><span class="emoji">🔍</span> 技术验证点</h3>
            <ul>
                <li><strong>状态一致性：</strong><code>localUIState</code> 与实际设置保持同步</li>
                <li><strong>更新原子性：</strong>每次只有一个设置在更新</li>
                <li><strong>UI响应性：</strong>按钮状态立即反映用户操作</li>
                <li><strong>错误恢复：</strong>即使出现错误，UI状态也能正确恢复</li>
            </ul>
        </div>

        <div class="test-section">
            <h2><span class="emoji">🚀</span> 技术亮点</h2>
            
            <h3>1. 状态分离架构</h3>
            <p>将UI状态与业务状态分离，避免了响应式系统的副作用。</p>
            
            <h3>2. 立即反馈机制</h3>
            <p>用户操作立即反映在UI上，提供流畅的用户体验。</p>
            
            <h3>3. 防冲突设计</h3>
            <p>通过 <code>isUpdatingSettings</code> 标志防止并发更新冲突。</p>
            
            <h3>4. 优雅降级</h3>
            <p>即使在错误情况下，UI状态也能正确恢复和同步。</p>
        </div>

        <div style="text-align: center; margin-top: 40px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
            <p><strong>🎉 修复完成！</strong></p>
            <p>UI同步问题已彻底解决，外观设置现在具有完美的状态隔离和响应性能。</p>
        </div>
    </div>

    <script>
        console.log('🧪 UI同步问题修复测试页面已加载');
        console.log('🔍 请按照测试步骤验证修复效果');
        console.log('📊 重点关注跨设置UI状态隔离测试');
    </script>
</body>
</html>
