<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>外观设置冲突修复测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            background: #f8f9fa;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            background: #f8f9fa;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .fix-item {
            background: #e8f5e8;
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            border-left: 3px solid #28a745;
        }
        .problem-item {
            background: #fff3cd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            border-left: 3px solid #ffc107;
        }
        .test-step {
            background: #e3f2fd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            border-left: 3px solid #2196f3;
        }
        .code-block {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
        }
        .success {
            color: #155724;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .warning {
            color: #856404;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .error {
            color: #721c24;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        h1 { color: #2c3e50; margin-bottom: 30px; }
        h2 { color: #34495e; margin-top: 30px; }
        h3 { color: #7f8c8d; }
        .highlight { background: #fff3cd; padding: 2px 6px; border-radius: 3px; }
        ul, ol { padding-left: 25px; }
        li { margin: 8px 0; }
        .badge {
            display: inline-block;
            padding: 4px 8px;
            background: #007bff;
            color: white;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .badge.fixed { background: #28a745; }
        .badge.critical { background: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🛠️ 外观设置冲突修复测试指南</h1>
        
        <div class="success">
            <strong>✅ 修复完成</strong><br>
            已成功解决外观配置逻辑中的冲突交互问题，实现了原子性操作和防冲突机制。
        </div>

        <div class="test-section">
            <h2>🔍 问题根因分析</h2>
            
            <div class="problem-item">
                <h3><span class="badge critical">严重</span> 多重响应式语句冲突</h3>
                <p><strong>问题：</strong>第74-81行和第84-86行的响应式语句都会在userPreferences变化时触发</p>
                <p><strong>后果：</strong>造成竞态条件，导致设置更新时的不可预测行为</p>
            </div>

            <div class="problem-item">
                <h3><span class="badge critical">严重</span> 设置更新的级联触发</h3>
                <p><strong>问题：</strong>每个设置函数都调用saveUserPreferences() → 触发store更新 → 触发响应式语句 → 重复调用applyTheme()</p>
                <p><strong>后果：</strong>造成重复应用和状态不一致</p>
            </div>

            <div class="problem-item">
                <h3><span class="badge critical">严重</span> 语言切换特殊处理冲突</h3>
                <p><strong>问题：</strong>handleLanguageChange直接调用setLanguage()，响应式语句可能同时调用initializeLanguage()</p>
                <p><strong>后果：</strong>两者可能同时修改语言状态，导致冲突</p>
            </div>

            <div class="problem-item">
                <h3><span class="badge">中等</span> 状态管理不一致</h3>
                <p><strong>问题：</strong>languageInitialized标志在快速切换时变得不可靠</p>
                <p><strong>后果：</strong>多个异步操作可能导致状态不同步</p>
            </div>
        </div>

        <div class="test-section">
            <h2>🛠️ 修复方案详解</h2>

            <div class="fix-item">
                <h3><span class="badge fixed">已修复</span> 统一设置更新机制</h3>
                <p>实现了<code>updateSetting()</code>函数，提供原子性操作和防抖机制：</p>
                <div class="code-block">
// 统一的设置更新函数，实现防抖和原子性操作
async function updateSetting(key: string, value: any, applyImmediately = false) {
  if (isUpdatingSettings) {
    pendingUpdates.set(key, value); // 排队等待
    return;
  }
  
  isUpdatingSettings = true;
  // 原子性更新逻辑...
}
                </div>
            </div>

            <div class="fix-item">
                <h3><span class="badge fixed">已修复</span> 响应式语句重构</h3>
                <p>合并冲突的响应式语句，只在首次加载时执行：</p>
                <div class="code-block">
// 统一的设置初始化逻辑 - 只在首次加载时执行
$: if (userPreferences && !$settingsStore.isLoading && 
      !languageInitialized && !isUpdatingSettings) {
  // 初始化逻辑...
}
                </div>
            </div>

            <div class="fix-item">
                <h3><span class="badge fixed">已修复</span> UI状态管理</h3>
                <p>为所有设置按钮添加禁用状态，防止重复操作：</p>
                <div class="code-block">
&lt;button
  disabled={isUpdatingSettings || !userPreferences}
  on:click={() => handleThemeChange('light')}
&gt;
                </div>
            </div>

            <div class="fix-item">
                <h3><span class="badge fixed">已修复</span> 错误处理和恢复</h3>
                <p>添加了全面的错误处理和状态恢复机制，确保即使出错也能恢复正常。</p>
            </div>
        </div>

        <div class="test-section">
            <h2>🧪 测试步骤</h2>

            <div class="test-step">
                <h3>步骤 1: 基础功能测试</h3>
                <ol>
                    <li>重新加载扩展（chrome://extensions/）</li>
                    <li>打开配置页面，进入"外观"设置</li>
                    <li>逐一测试每个设置：主题、语言、字体大小、消息密度</li>
                    <li>确认每个设置都能正常工作</li>
                </ol>
            </div>

            <div class="test-step">
                <h3>步骤 2: 快速切换测试</h3>
                <ol>
                    <li>快速连续点击不同的主题选项（浅色→深色→自动→浅色）</li>
                    <li>快速切换语言（中文→英文→中文→英文）</li>
                    <li>快速调整字体大小（小→中→大→小）</li>
                    <li>快速切换消息密度（紧凑→正常→宽松→紧凑）</li>
                </ol>
                <div class="warning">
                    <strong>预期结果：</strong>所有设置都应该正确响应，不应该出现卡死或无响应的情况
                </div>
            </div>

            <div class="test-step">
                <h3>步骤 3: 混合设置测试</h3>
                <ol>
                    <li>先切换主题，立即切换语言</li>
                    <li>在语言切换过程中，立即调整字体大小</li>
                    <li>在字体调整过程中，立即切换消息密度</li>
                    <li>重复以上步骤多次</li>
                </ol>
                <div class="warning">
                    <strong>预期结果：</strong>设置应该按顺序正确应用，不应该相互干扰
                </div>
            </div>

            <div class="test-step">
                <h3>步骤 4: 控制台日志检查</h3>
                <ol>
                    <li>打开浏览器开发者工具</li>
                    <li>在进行设置更改时观察控制台输出</li>
                    <li>查找以下日志模式：</li>
                </ol>
                <div class="code-block">
🔧 [Options] Updating setting: theme = light
✅ [Options] Setting theme updated successfully
⏳ [Options] Settings update in progress, queuing: language
🔧 [Options] Updating setting: language = en
✅ [Options] Setting language updated successfully
                </div>
            </div>
        </div>

        <div class="test-section">
            <h2>✅ 成功标准</h2>

            <div class="success">
                <h3>1. 功能可靠性</h3>
                <ul>
                    <li>所有外观设置都能正常工作</li>
                    <li>设置更改立即生效</li>
                    <li>不出现间歇性失败</li>
                </ul>
            </div>

            <div class="success">
                <h3>2. 操作顺序无关性</h3>
                <ul>
                    <li>无论以何种顺序更改设置，都能正确工作</li>
                    <li>快速连续操作不会导致冲突</li>
                    <li>不出现级联失败</li>
                </ul>
            </div>

            <div class="success">
                <h3>3. 状态一致性</h3>
                <ul>
                    <li>UI状态与实际设置保持一致</li>
                    <li>页面刷新后设置正确保持</li>
                    <li>不出现状态不同步</li>
                </ul>
            </div>

            <div class="success">
                <h3>4. 错误恢复</h3>
                <ul>
                    <li>即使出现错误，系统能自动恢复</li>
                    <li>控制台无严重错误信息</li>
                    <li>用户体验流畅</li>
                </ul>
            </div>
        </div>

        <div class="test-section">
            <h2>🔧 技术实现亮点</h2>

            <div class="fix-item">
                <h3>原子性操作</h3>
                <p>通过<code>isUpdatingSettings</code>标志确保同时只有一个设置更新操作在进行</p>
            </div>

            <div class="fix-item">
                <h3>队列机制</h3>
                <p>使用<code>pendingUpdates</code> Map存储待处理的更新，确保不丢失用户操作</p>
            </div>

            <div class="fix-item">
                <h3>防抖处理</h3>
                <p>通过延迟处理下一个更新，避免快速连续操作造成的冲突</p>
            </div>

            <div class="fix-item">
                <h3>状态隔离</h3>
                <p>将初始化逻辑与更新逻辑分离，避免相互干扰</p>
            </div>

            <div class="fix-item">
                <h3>UI反馈</h3>
                <p>通过禁用按钮状态为用户提供视觉反馈，防止重复操作</p>
            </div>
        </div>

        <div class="warning">
            <h3>⚠️ 注意事项</h3>
            <ul>
                <li>测试时请确保网络连接稳定</li>
                <li>建议在不同浏览器环境下测试</li>
                <li>如发现问题，请查看控制台日志并记录详细步骤</li>
                <li>测试完成后，请验证设置是否正确保存到存储中</li>
            </ul>
        </div>
    </div>

    <script>
        console.log('🧪 外观设置冲突修复测试页面已加载');
        console.log('📋 请按照上述步骤进行全面测试');
        console.log('🔍 重点关注快速切换和混合设置测试');
    </script>
</body>
</html>
