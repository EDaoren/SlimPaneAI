<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”§ æµå¼ä»£ç é«˜äº®ä¿®å¤æµ‹è¯•</title>
    
    <!-- å¼•å…¥ highlight.js å’Œä¸»é¢˜ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    
    <!-- å¼•å…¥ highlightjs-copy æ’ä»¶ -->
    <script src="https://unpkg.com/highlightjs-copy/dist/highlightjs-copy.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/highlightjs-copy/dist/highlightjs-copy.min.css">
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #0d1117;
            color: #e6edf3;
        }
        
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #30363d;
            border-radius: 8px;
            background: #161b22;
        }
        
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: 500;
        }
        
        .status:not(.error) {
            background: #0d4429;
            color: #3fb950;
            border: 1px solid #238636;
        }
        
        .status.error {
            background: #490202;
            color: #f85149;
            border: 1px solid #da3633;
        }
        
        .controls {
            margin: 20px 0;
        }
        
        button {
            background: #238636;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        
        button:hover {
            background: #2ea043;
        }
        
        button:disabled {
            background: #484f58;
            cursor: not-allowed;
        }
        
        .message-content {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 16px;
            margin: 10px 0;
        }
        
        .streaming-indicator {
            color: #7c3aed;
            font-size: 0.9em;
            margin: 10px 0;
        }
        
        /* æ¨¡æ‹Ÿ MessageItem çš„æ ·å¼ */
        .message-content pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin: 0.5rem 0;
            font-size: 0.875rem;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            overflow-x: auto;
            line-height: 1.4;
            border: 1px solid #334155;
        }
        
        .message-content .hljs {
            border-radius: 0.5rem !important;
            margin: 0.5rem 0 !important;
            font-size: 0.875rem !important;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ æµå¼ä»£ç é«˜äº®ä¿®å¤æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>ä¿®å¤çŠ¶æ€</h2>
        <div id="fix-status" class="status">å‡†å¤‡æµ‹è¯•æµå¼ä»£ç é«˜äº®ä¿®å¤...</div>
    </div>
    
    <div class="controls">
        <button id="start-test" onclick="startStreamingTest()">å¼€å§‹æµå¼æµ‹è¯•</button>
        <button id="stop-test" onclick="stopStreamingTest()" disabled>åœæ­¢æµ‹è¯•</button>
        <button onclick="clearContent()">æ¸…ç©ºå†…å®¹</button>
    </div>
    
    <div class="test-section">
        <h2>æµå¼è¾“å‡ºæ¨¡æ‹Ÿ</h2>
        <div id="streaming-indicator" class="streaming-indicator" style="display: none;">
            ğŸ”„ æ­£åœ¨æ¨¡æ‹Ÿæµå¼è¾“å‡º...
        </div>
        <div id="message-content" class="message-content"></div>
    </div>
    
    <script>
        // åˆå§‹åŒ– highlightjs-copy æ’ä»¶
        hljs.addPlugin(new CopyButtonPlugin({
            lang: 'zh-CN',
            callback: (text, el) => {
                console.log('ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                updateStatus('âœ… ä»£ç å¤åˆ¶æˆåŠŸï¼æµå¼é«˜äº®ä¿®å¤æ•ˆæœæ­£å¸¸ã€‚', false);
            }
        }));
        
        let streamingInterval;
        let currentContent = '';
        let isStreaming = false;
        
        // æ¨¡æ‹Ÿçš„ä»£ç å†…å®¹
        const codeContent = `# Python ç¤ºä¾‹ä»£ç 
def fibonacci(n):
    """è®¡ç®—æ–æ³¢é‚£å¥‘æ•°åˆ—"""
    if n <= 1:
        return n
    return fibonacci(n-1) + fibonacci(n-2)

# JavaScript ç¤ºä¾‹
function quickSort(arr) {
    if (arr.length <= 1) return arr;
    
    const pivot = arr[Math.floor(arr.length / 2)];
    const left = arr.filter(x => x < pivot);
    const right = arr.filter(x => x > pivot);
    const middle = arr.filter(x => x === pivot);
    
    return [...quickSort(left), ...middle, ...quickSort(right)];
}

# CSS ç¤ºä¾‹
.container {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}`;
        
        // æ¨¡æ‹Ÿæµå¼è¾“å‡ºçš„å†…å®¹
        const streamingContent = `è¿™æ˜¯ä¸€ä¸ªä»£ç é«˜äº®æµ‹è¯•ã€‚ä¸‹é¢æ˜¯ä¸€äº›ç¤ºä¾‹ä»£ç ï¼š

\`\`\`python
${codeContent}
\`\`\`

æµ‹è¯•å®Œæˆï¼ä»£ç é«˜äº®åº”è¯¥åœ¨æµå¼è¾“å‡ºè¿‡ç¨‹ä¸­ä¿æŒç¨³å®šï¼Œä¸ä¼šé—ªçƒã€‚`;
        
        function updateStatus(message, isError = false) {
            const statusEl = document.getElementById('fix-status');
            statusEl.textContent = message;
            statusEl.className = isError ? 'status error' : 'status';
        }
        
        function startStreamingTest() {
            if (isStreaming) return;
            
            isStreaming = true;
            currentContent = '';
            document.getElementById('start-test').disabled = true;
            document.getElementById('stop-test').disabled = false;
            document.getElementById('streaming-indicator').style.display = 'block';
            
            updateStatus('ğŸ”„ å¼€å§‹æµå¼è¾“å‡ºæµ‹è¯•...', false);
            
            let charIndex = 0;
            streamingInterval = setInterval(() => {
                if (charIndex < streamingContent.length) {
                    currentContent += streamingContent[charIndex];
                    charIndex++;
                    
                    // æ¨¡æ‹Ÿ markdown æ¸²æŸ“ï¼ˆç®€åŒ–ç‰ˆï¼‰
                    renderContent(currentContent);
                } else {
                    stopStreamingTest();
                }
            }, 50); // 50ms é—´éš”æ¨¡æ‹Ÿå¿«é€Ÿæµå¼è¾“å‡º
        }
        
        function stopStreamingTest() {
            if (!isStreaming) return;
            
            isStreaming = false;
            clearInterval(streamingInterval);
            document.getElementById('start-test').disabled = false;
            document.getElementById('stop-test').disabled = true;
            document.getElementById('streaming-indicator').style.display = 'none';
            
            // æœ€ç»ˆé«˜äº®
            highlightCodeBlocks();
            updateStatus('âœ… æµå¼è¾“å‡ºæµ‹è¯•å®Œæˆï¼æ£€æŸ¥ä»£ç é«˜äº®æ˜¯å¦ç¨³å®šã€‚', false);
        }
        
        function clearContent() {
            currentContent = '';
            document.getElementById('message-content').innerHTML = '';
            updateStatus('å†…å®¹å·²æ¸…ç©ºï¼Œå¯ä»¥é‡æ–°å¼€å§‹æµ‹è¯•ã€‚', false);
        }
        
        function renderContent(content) {
            const container = document.getElementById('message-content');
            
            // ç®€å•çš„ markdown æ¸²æŸ“ï¼ˆåªå¤„ç†ä»£ç å—ï¼‰
            let html = content
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\n/g, '<br>');
            
            // å¤„ç†ä»£ç å—
            html = html.replace(/```(\w+)?\n?([\s\S]*?)```/g, (match, lang, code) => {
                const language = lang || '';
                const cleanCode = code.replace(/<br>/g, '\n');
                return `<pre><code class="language-${language}">${cleanCode}</code></pre>`;
            });
            
            container.innerHTML = html;
            
            // é˜²æŠ–é«˜äº®ï¼ˆæ¨¡æ‹Ÿä¿®å¤åçš„é€»è¾‘ï¼‰
            clearTimeout(window.highlightTimeout);
            window.highlightTimeout = setTimeout(() => {
                highlightCodeBlocks();
            }, 150);
        }
        
        function highlightCodeBlocks() {
            const container = document.getElementById('message-content');
            const codeBlocks = container.querySelectorAll('pre code');

            if (codeBlocks.length === 0) return;

            codeBlocks.forEach((block) => {
                try {
                    const codeElement = block;
                    const preElement = codeElement.parentElement;

                    // å¦‚æœè¿˜æ²¡æœ‰hljsç±»ï¼Œè¿›è¡Œé«˜äº®
                    if (!codeElement.classList.contains('hljs')) {
                        hljs.highlightElement(codeElement);
                    }

                    // ç¡®ä¿preå…ƒç´ ä¹Ÿæœ‰hljsç±»ï¼ˆç”¨äºæ ·å¼ï¼‰
                    if (preElement && preElement.tagName === 'PRE' && !preElement.classList.contains('hljs')) {
                        preElement.classList.add('hljs');
                    }
                } catch (error) {
                    console.warn('Failed to highlight code block:', error);
                }
            });
        }
        
        // åˆå§‹çŠ¶æ€
        updateStatus('âœ… é¡µé¢åŠ è½½å®Œæˆï¼Œç‚¹å‡»"å¼€å§‹æµå¼æµ‹è¯•"æ¥æµ‹è¯•ä¿®å¤æ•ˆæœã€‚', false);
    </script>
</body>
</html>
