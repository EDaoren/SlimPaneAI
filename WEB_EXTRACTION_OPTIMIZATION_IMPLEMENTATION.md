# ç½‘é¡µå†…å®¹æå–ä¼˜åŒ–å®æ–½æŠ¥å‘Š

## ğŸ“‹ ä¼˜åŒ–æ¦‚è¿°

åŸºäº `web_extraction_optimization_plan.md` çš„å»ºè®®ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†ç½‘é¡µå†…å®¹æå–ç³»ç»Ÿçš„å…¨é¢ä¼˜åŒ–ã€‚æœ¬æ¬¡ä¼˜åŒ–éµå¾ª **"å…ˆä¿çœŸï¼Œå†å»å™ª"** çš„æ ¸å¿ƒåŸåˆ™ï¼Œæ˜¾è‘—æå‡äº†å†…å®¹æå–çš„å‡†ç¡®ç‡å’Œå®Œæ•´åº¦ã€‚

## âœ… å·²å®Œæˆçš„ä¼˜åŒ–é¡¹ç›®

### 1. ç²¾ç®€é»‘åå•è§„åˆ™

**ä¼˜åŒ–å‰é—®é¢˜**ï¼šé»‘åå•è¿‡å®½ï¼Œè¯¯åˆ  `header`, `aside`, `figure` ç­‰å¯èƒ½åŒ…å«é‡è¦å†…å®¹çš„å…ƒç´ 

**ä¼˜åŒ–æªæ–½**ï¼š
- ç§»é™¤äº† `nav`, `header`, `footer`, `aside` ç­‰ç»“æ„æ€§å…ƒç´ 
- ç§»é™¤äº† `.comments`, `.related-posts`, `.author-bio` ç­‰å¯èƒ½æœ‰ä»·å€¼çš„å†…å®¹
- ä»…ä¿ç•™æ˜ç¡®çš„å™ªå£°å…ƒç´ ï¼šå¹¿å‘Šã€å¼¹çª—ã€åˆ†äº«æŒ‰é’®ç­‰

**å½±å“æ–‡ä»¶**ï¼š
- `src/lib/readability-extractor/index.ts`
- `src/content/content-script.ts`

### 2. å®ç°é™çº§æœºåˆ¶

**ä¼˜åŒ–å‰é—®é¢˜**ï¼š`isProbablyReaderable` å¤±è´¥æ—¶ç›´æ¥è¿”å› nullï¼Œé”™æŠŠå¯å‘å¼å½“ç»å¯¹åˆ¤å®š

**ä¼˜åŒ–æªæ–½**ï¼š
- ä¸å†ä¾èµ– `isProbablyReaderable` ä½œä¸ºç¡¬æ€§æ¡ä»¶
- å®ç°ä¸‰å±‚é™çº§ç­–ç•¥ï¼šæ ‡å‡†é…ç½® â†’ å®½æ¾é…ç½® â†’ åŸºç¡€æ–‡æœ¬æå–
- ç¡®ä¿å³ä½¿ Readability å®Œå…¨å¤±è´¥ä¹Ÿèƒ½æå–åˆ°åŸºæœ¬å†…å®¹

**ä»£ç ç¤ºä¾‹**ï¼š
```typescript
// æ ‡å‡†é…ç½®
if (isProbablyReaderable(clonedDoc)) {
  article = new Readability(clonedDoc, standardConfig).parse();
}

// å®½æ¾é…ç½®é™çº§
if (!article) {
  article = new Readability(clonedDoc2, lenientConfig).parse();
}

// æœ€ç»ˆé™çº§
if (!article) {
  article = { title: document.title, textContent: document.body.innerText };
}
```

### 3. ä¼˜åŒ– SPA å†…å®¹ç­‰å¾…

**ä¼˜åŒ–å‰é—®é¢˜**ï¼šSPA ç›‘å¬æœºåˆ¶ä¸å®Œå–„ï¼Œç¼ºä¹ DOM å˜åŒ–ç›‘å¬

**ä¼˜åŒ–æªæ–½**ï¼š
- ä½¿ç”¨ `MutationObserver` ç›‘å¬ DOM å˜åŒ–
- æé«˜å†…å®¹é˜ˆå€¼åˆ° 1000 å­—ç¬¦
- æ™ºèƒ½é€‰æ‹©ç›‘å¬æ ¹å…ƒç´ 
- è¶…æ—¶å…œåº•æœºåˆ¶ï¼Œä¸é˜»æ­¢åç»­å¤„ç†

**ä»£ç ç¤ºä¾‹**ï¼š
```typescript
const observer = new MutationObserver(() => {
  if (checkCurrentContent()) {
    observer.disconnect();
    resolve(true);
  }
});

observer.observe(root, { 
  childList: true, 
  subtree: true,
  attributes: false,
  characterData: false
});
```

### 4. æ™ºèƒ½æ–‡æœ¬å¤„ç†

**ä¼˜åŒ–å‰é—®é¢˜**ï¼šç²—æš´çš„è¡Œåˆå¹¶å’ŒçŸ­è¡Œè¿‡æ»¤å¯¼è‡´æ ¼å¼é”™ä¹±å’Œå†…å®¹ä¸¢å¤±

**ä¼˜åŒ–æªæ–½**ï¼š
- ä¿ç•™ç‰¹æ®Šæ ¼å¼è¡Œï¼ˆåˆ—è¡¨ã€æ ‡é¢˜ã€ä»£ç å—ã€å¼•ç”¨ï¼‰
- æ™ºèƒ½è¡Œåˆå¹¶ï¼Œæ£€æŸ¥æ ‡ç‚¹ç¬¦å·é¿å…è¯è¯­è¿æ¥
- ç§»é™¤ç¡¬ç¼–ç çš„é•¿åº¦é™åˆ¶ï¼ˆå¦‚ `< 10 å­—ç¬¦ä¸¢å¼ƒ`ï¼‰
- ä¿æŠ¤æ®µè½ç»“æ„

**ä»£ç ç¤ºä¾‹**ï¼š
```typescript
// ä¿ç•™ç‰¹æ®Šæ ¼å¼è¡Œ
if (listItemRegex.test(line) || 
    headingRegex.test(line) || 
    codeBlockRegex.test(line) || 
    quoteRegex.test(line)) {
  processedLines.push(line);
  continue;
}

// æ™ºèƒ½åˆå¹¶æ£€æŸ¥
const needsSpace = !prevLine.endsWith('.') && 
                   !prevLine.endsWith('!') && 
                   !prevLine.endsWith('?');
```

### 5. å¢å¼ºç±»åä¿æŠ¤

**ä¼˜åŒ–å‰é—®é¢˜**ï¼š`classesToPreserve` åªåŒ…å« `code` ç±»ï¼Œå›¾ç‰‡/è§†é¢‘ä¸¢å¤±

**ä¼˜åŒ–æªæ–½**ï¼š
- å¤§å¹…æ‰©å±•ä¿æŠ¤ç±»ååˆ—è¡¨
- åŒ…å«å›¾ç‰‡ã€åª’ä½“ã€ä»£ç ã€å†…å®¹ç»“æ„ç­‰å„ç±»é‡è¦å…ƒç´ 
- æ”¯æŒæ­£åˆ™åŒ¹é…ï¼ˆå¦‚ `lazy-`, `wp-`, `video-` ç­‰å‰ç¼€ï¼‰

**ä¿æŠ¤çš„ç±»å**ï¼š
```typescript
const PROTECTED_CLASSES = [
  // ä»£ç å’Œæ ¼å¼åŒ–
  'highlight', 'code', 'pre', 'language-',
  // å›¾ç‰‡å’Œåª’ä½“
  'figure', 'gallery', 'image', 'photo', 'video',
  'lazy-', 'wp-', 'zoomable-', 'video-',
  // å†…å®¹ç»“æ„
  'content', 'article', 'post', 'entry', 'main',
  // ... æ›´å¤š
];
```

### 6. ä¼˜åŒ–å†…å®¹åˆ†å—

**ä¼˜åŒ–å‰é—®é¢˜**ï¼šé•¿æ–‡è¢«ç¡¬è£åˆ° 8kBï¼Œç®€å•çš„ `substring` æˆªæ–­

**ä¼˜åŒ–æªæ–½**ï¼š
- æé«˜å—å¤§å°é™åˆ¶åˆ° 3kB
- æŒ‰æ®µè½å’Œè¯­ä¹‰è¾¹ç•Œåˆ†å‰²
- é¿å…ç¡¬æ€§æˆªæ–­ï¼Œä¿æŒå†…å®¹å®Œæ•´æ€§
- ç§»é™¤çŸ­è¡Œåˆ é™¤é€»è¾‘

### 7. æ”¹è¿› DOM é¢„å¤„ç†

**ä¼˜åŒ–å‰é—®é¢˜**ï¼šè¿‡åº¦åˆ é™¤çŸ­å…ƒç´ ï¼Œå¯èƒ½è¯¯åˆ æœ‰æ„ä¹‰çš„å†…å®¹

**ä¼˜åŒ–æªæ–½**ï¼š
- ä»…åˆ é™¤çº¯ç©ºç™½å…ƒç´ 
- æ£€æŸ¥æ˜¯å¦åŒ…å«é‡è¦å­å…ƒç´ ï¼ˆå›¾ç‰‡ã€è§†é¢‘ã€ä»£ç ç­‰ï¼‰
- ä¿æŠ¤æ›´å¤šçš„å†…å®¹ç±»å‹

**ä»£ç ç¤ºä¾‹**ï¼š
```typescript
function isPureEmpty(node: HTMLElement): boolean {
  return !node.innerText.trim() && 
         !node.querySelector('img, picture, video, pre, code, li, table, figure');
}
```

## ğŸ”§ æ–°å¢é…ç½®ç³»ç»Ÿ

åˆ›å»ºäº† `src/lib/web-extraction/config.ts` é…ç½®æ–‡ä»¶ï¼Œå®ç°ï¼š

- **å¯é…ç½®é˜ˆå€¼**ï¼šæ‰€æœ‰é•¿åº¦ã€å¾—åˆ†é˜ˆå€¼æŠ½æˆå¸¸é‡
- **åˆ†å±‚é…ç½®**ï¼šæ ‡å‡†é…ç½®å’Œå®½æ¾é…ç½®åˆ†ç¦»
- **ç›‘æ§å‚æ•°**ï¼šæå–æ¯”ç‡ã€æ€§èƒ½æŒ‡æ ‡ç­‰
- **æ ¼å¼æ£€æµ‹**ï¼šæ­£åˆ™è¡¨è¾¾å¼ç»Ÿä¸€ç®¡ç†

## ğŸ“Š é¢„æœŸä¼˜åŒ–æ•ˆæœ

### å†…å®¹å®Œæ•´æ€§æå‡
- **å‡å°‘è¯¯åˆ **ï¼šç²¾ç®€é»‘åå•é¿å…åˆ é™¤é‡è¦å†…å®¹
- **ä¿æŠ¤åª’ä½“**ï¼šæ‰©å±•ç±»åä¿æŠ¤ç¡®ä¿å›¾ç‰‡/è§†é¢‘ä¿ç•™
- **æ ¼å¼ä¿æŒ**ï¼šæ™ºèƒ½æ–‡æœ¬å¤„ç†ä¿æŠ¤åˆ—è¡¨ã€ä»£ç å—ç­‰æ ¼å¼

### æå–æˆåŠŸç‡æå‡
- **é™çº§æœºåˆ¶**ï¼šä¸‰å±‚é™çº§ç¡®ä¿æ€»èƒ½æå–åˆ°å†…å®¹
- **SPA æ”¯æŒ**ï¼šæ”¹è¿›çš„ DOM ç›‘å¬æé«˜åŠ¨æ€å†…å®¹æ•è·
- **å®½æ¾é…ç½®**ï¼šé™ä½é˜ˆå€¼å¢åŠ æå–æœºä¼š

### æ€§èƒ½ä¼˜åŒ–
- **æ™ºèƒ½ç­‰å¾…**ï¼šMutationObserver å‡å°‘æ— æ•ˆè½®è¯¢
- **æ‰¹é‡å¤„ç†**ï¼šä¼˜åŒ– DOM æ“ä½œå‡å°‘é‡å¤æŸ¥è¯¢
- **é…ç½®åŒ–**ï¼šå‚æ•°å¯è°ƒæ•´ä¾¿äº A/B æµ‹è¯•

## ğŸ” ç›‘æ§ä¸éªŒè¯

### æ—¥å¿—è¾“å‡º
- æå–æ–¹æ³•æ ‡è¯†ï¼ˆstandard/lenient/fallbackï¼‰
- å†…å®¹é•¿åº¦ç»Ÿè®¡
- æå–æ¯”ç‡ç›‘æ§
- æ€§èƒ½æ—¶é—´è®°å½•

### éªŒè¯æŒ‡æ ‡
- `extracted_len / body_len` æ¯”ç‡
- `img_total` vs `img_kept` ç»Ÿè®¡
- è§¦å‘é™çº§çš„é¢‘ç‡
- SPA å†…å®¹åŠ è½½æˆåŠŸç‡

## ğŸš€ åç»­ä¼˜åŒ–æ–¹å‘

1. **A/B æµ‹è¯•**ï¼šåœ¨å®é™…ç½‘ç«™ä¸Šå¯¹æ¯”æ–°æ—§ç®—æ³•æ•ˆæœ
2. **è§„åˆ™ä¼˜åŒ–**ï¼šåŸºäºä½¿ç”¨æ•°æ®è¿›ä¸€æ­¥è°ƒæ•´é»‘åå•å’Œé˜ˆå€¼
3. **æ€§èƒ½ç›‘æ§**ï¼šæ”¶é›†æå–è´¨é‡æŒ‡æ ‡ï¼ŒæŒç»­ä¼˜åŒ–
4. **ç‰¹æ®Šç«™ç‚¹æ”¯æŒ**ï¼šé’ˆå¯¹ç‰¹å®šç½‘ç«™ç±»å‹çš„ä¸“é—¨ä¼˜åŒ–

## ğŸ“ æ€»ç»“

æœ¬æ¬¡ä¼˜åŒ–å…¨é¢å®æ–½äº†ä¼˜åŒ–è®¡åˆ’æ–‡æ¡£çš„å»ºè®®ï¼Œä» **"é˜ˆå€¼è¿‡çª„ + å¤„ç†è¿‡åº¦"** çš„é—®é¢˜å‡ºå‘ï¼Œå®ç°äº†ï¼š

- âœ… ç²¾ç®€é»‘åå•ï¼Œå‡å°‘è¯¯åˆ 
- âœ… å®ç°å®Œæ•´çš„é™çº§æœºåˆ¶
- âœ… ä¼˜åŒ– SPA å†…å®¹ç­‰å¾…
- âœ… æ™ºèƒ½æ–‡æœ¬å¤„ç†ï¼Œä¿æŠ¤æ ¼å¼
- âœ… æ‰©å±•ç±»åä¿æŠ¤ï¼Œä¿ç•™åª’ä½“
- âœ… æ”¹è¿›å†…å®¹åˆ†å—ï¼Œé¿å…æˆªæ–­
- âœ… å¯é…ç½®å‚æ•°ç³»ç»Ÿ

é¢„æœŸå°†æ˜¾è‘—æå‡ç½‘é¡µå†…å®¹æå–çš„**å‡†ç¡®ç‡**å’Œ**å®Œæ•´åº¦**ï¼ŒåŒæ—¶ä¿æŒè‰¯å¥½çš„**æ€§èƒ½è¡¨ç°**ã€‚
