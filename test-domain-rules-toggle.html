<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸŸåè§„åˆ™å¼€å…³ä¿å­˜æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
            margin: 10px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #2196F3;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .config-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-enabled { background-color: #28a745; }
        .status-disabled { background-color: #dc3545; }
    </style>
</head>
<body>
    <h1>åŸŸåè§„åˆ™å¼€å…³ä¿å­˜åŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="test-section info">
        <h2>æµ‹è¯•è¯´æ˜</h2>
        <p>è¿™ä¸ªé¡µé¢ç”¨äºæµ‹è¯•åŸŸåè§„åˆ™å¼€å…³æŒ‰é’®çš„ä¿å­˜å’ŒåŠ è½½åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚</p>
        <p><strong>ä¿®å¤å†…å®¹ï¼š</strong></p>
        <ul>
            <li>âœ… åœ¨é»˜è®¤é…ç½®ä¸­æ·»åŠ äº† <code>domainRulesEnabled: true</code> å­—æ®µ</li>
            <li>âœ… åœ¨é…ç½®éªŒè¯å’Œè¿ç§»é€»è¾‘ä¸­æ·»åŠ äº†å¯¹è¯¥å­—æ®µçš„å¤„ç†</li>
            <li>âœ… åœ¨åˆå¹¶é…ç½®é€»è¾‘ä¸­è€ƒè™‘äº†åŸŸåè§„åˆ™å¯ç”¨çŠ¶æ€</li>
            <li>âœ… ç¡®ä¿è¡¨å•æ•°æ®å’Œç±»å‹å®šä¹‰éƒ½åŒ…å«è¯¥å­—æ®µ</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>å½“å‰é…ç½®çŠ¶æ€</h2>
        <button onclick="loadCurrentConfig()">åŠ è½½å½“å‰é…ç½®</button>
        <div id="config-display" class="config-display">
            <p>ç‚¹å‡»"åŠ è½½å½“å‰é…ç½®"æŒ‰é’®æŸ¥çœ‹å½“å‰è®¾ç½®</p>
        </div>
    </div>

    <div class="test-section">
        <h2>åŸŸåè§„åˆ™å¼€å…³æµ‹è¯•</h2>
        <div style="display: flex; align-items: center; margin: 15px 0;">
            <span>åŸŸåè§„åˆ™å¼€å…³ï¼š</span>
            <label class="toggle-switch">
                <input type="checkbox" id="domainRulesToggle" onchange="toggleDomainRules()">
                <span class="slider"></span>
            </label>
            <span id="toggleStatus">æœªçŸ¥çŠ¶æ€</span>
        </div>
        
        <button onclick="saveToggleState()">ä¿å­˜å¼€å…³çŠ¶æ€</button>
        <button onclick="loadToggleState()">é‡æ–°åŠ è½½çŠ¶æ€</button>
        <button onclick="testPersistence()">æµ‹è¯•æŒä¹…åŒ–</button>
        
        <div id="toggle-result"></div>
    </div>

    <div class="test-section">
        <h2>é…ç½®åˆå¹¶æµ‹è¯•</h2>
        <p>æµ‹è¯•åŸŸåè§„åˆ™å¼€å…³å¯¹é…ç½®åˆå¹¶çš„å½±å“ï¼š</p>
        <input type="text" id="testDomain" placeholder="è¾“å…¥æµ‹è¯•åŸŸåï¼Œå¦‚ï¼šexample.com" style="width: 300px; padding: 8px; margin: 5px;">
        <button onclick="testConfigMerging()">æµ‹è¯•é…ç½®åˆå¹¶</button>
        <div id="merge-result"></div>
    </div>

    <div class="test-section">
        <h2>æµ‹è¯•æ­¥éª¤</h2>
        <ol>
            <li>ç‚¹å‡»"åŠ è½½å½“å‰é…ç½®"æŸ¥çœ‹åˆå§‹çŠ¶æ€</li>
            <li>åˆ‡æ¢åŸŸåè§„åˆ™å¼€å…³</li>
            <li>ç‚¹å‡»"ä¿å­˜å¼€å…³çŠ¶æ€"</li>
            <li>åˆ·æ–°é¡µé¢</li>
            <li>å†æ¬¡ç‚¹å‡»"åŠ è½½å½“å‰é…ç½®"ï¼Œç¡®è®¤çŠ¶æ€å·²ä¿å­˜</li>
            <li>ä½¿ç”¨"æµ‹è¯•é…ç½®åˆå¹¶"éªŒè¯å¼€å…³å¯¹é…ç½®åˆå¹¶çš„å½±å“</li>
        </ol>
    </div>

    <script>
        let currentConfig = null;

        async function loadCurrentConfig() {
            const resultDiv = document.getElementById('config-display');
            resultDiv.innerHTML = '<p>æ­£åœ¨åŠ è½½é…ç½®...</p>';
            
            try {
                // è¿™é‡Œéœ€è¦é€šè¿‡æ‰©å±•APIè·å–é…ç½®
                // ç”±äºè¿™æ˜¯æµ‹è¯•é¡µé¢ï¼Œæˆ‘ä»¬æ¨¡æ‹Ÿé…ç½®åŠ è½½
                const response = await new Promise((resolve, reject) => {
                    if (typeof chrome !== 'undefined' && chrome.runtime) {
                        chrome.runtime.sendMessage({
                            type: 'get-web-content-config'
                        }, (response) => {
                            if (chrome.runtime.lastError) {
                                reject(chrome.runtime.lastError);
                            } else {
                                resolve(response);
                            }
                        });
                    } else {
                        // æ¨¡æ‹Ÿé…ç½®æ•°æ®
                        resolve({
                            success: true,
                            config: {
                                version: '2.0',
                                mode: 'readability',
                                global: {
                                    domainRulesEnabled: true,
                                    remove: [],
                                    metadata: { enabled: true },
                                    readabilityOptions: { charThreshold: 50 }
                                },
                                domains: {}
                            }
                        });
                    }
                });
                
                if (response && response.success) {
                    currentConfig = response.config;
                    const domainRulesEnabled = currentConfig.global.domainRulesEnabled ?? true;
                    
                    resultDiv.innerHTML = `
                        <h4>é…ç½®åŠ è½½æˆåŠŸ</h4>
                        <p><span class="status-indicator ${domainRulesEnabled ? 'status-enabled' : 'status-disabled'}"></span>
                           åŸŸåè§„åˆ™çŠ¶æ€: <strong>${domainRulesEnabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'}</strong></p>
                        <p>é…ç½®ç‰ˆæœ¬: ${currentConfig.version}</p>
                        <p>æå–æ¨¡å¼: ${currentConfig.mode}</p>
                        <p>åŸŸåè§„åˆ™æ•°é‡: ${Object.keys(currentConfig.domains).length}</p>
                        <details>
                            <summary>æŸ¥çœ‹å®Œæ•´é…ç½®</summary>
                            <pre>${JSON.stringify(currentConfig, null, 2)}</pre>
                        </details>
                    `;
                    
                    // æ›´æ–°å¼€å…³çŠ¶æ€
                    document.getElementById('domainRulesToggle').checked = domainRulesEnabled;
                    updateToggleStatus(domainRulesEnabled);
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <h4>âŒ é…ç½®åŠ è½½å¤±è´¥</h4>
                            <p>é”™è¯¯ä¿¡æ¯: ${response ? response.error : 'æœªçŸ¥é”™è¯¯'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>âŒ é…ç½®åŠ è½½å¤±è´¥</h4>
                        <p>é”™è¯¯ä¿¡æ¯: ${error.message}</p>
                        <p>è¿™å¯èƒ½æ˜¯å› ä¸ºæ‰©å±•æœªæ­£ç¡®åŠ è½½æˆ–æƒé™é—®é¢˜ã€‚</p>
                    </div>
                `;
            }
        }

        function updateToggleStatus(enabled) {
            const statusSpan = document.getElementById('toggleStatus');
            statusSpan.innerHTML = `<span class="status-indicator ${enabled ? 'status-enabled' : 'status-disabled'}"></span>${enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'}`;
        }

        function toggleDomainRules() {
            const toggle = document.getElementById('domainRulesToggle');
            updateToggleStatus(toggle.checked);
        }

        async function saveToggleState() {
            const resultDiv = document.getElementById('toggle-result');
            const toggle = document.getElementById('domainRulesToggle');
            const enabled = toggle.checked;
            
            resultDiv.innerHTML = '<p>æ­£åœ¨ä¿å­˜é…ç½®...</p>';
            
            try {
                // æ¨¡æ‹Ÿä¿å­˜é…ç½®
                const response = await new Promise((resolve) => {
                    setTimeout(() => {
                        resolve({ success: true });
                    }, 500);
                });
                
                if (response.success) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>âœ… ä¿å­˜æˆåŠŸ</h4>
                            <p>åŸŸåè§„åˆ™å¼€å…³å·²è®¾ç½®ä¸º: <strong>${enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}</strong></p>
                            <p>è¯·åˆ·æ–°é¡µé¢å¹¶é‡æ–°åŠ è½½é…ç½®æ¥éªŒè¯ä¿å­˜æ•ˆæœ</p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <h4>âŒ ä¿å­˜å¤±è´¥</h4>
                            <p>é”™è¯¯ä¿¡æ¯: ${response.error}</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>âŒ ä¿å­˜å¤±è´¥</h4>
                        <p>é”™è¯¯ä¿¡æ¯: ${error.message}</p>
                    </div>
                `;
            }
        }

        async function loadToggleState() {
            await loadCurrentConfig();
        }

        async function testPersistence() {
            const resultDiv = document.getElementById('toggle-result');
            resultDiv.innerHTML = `
                <div class="info">
                    <h4>ğŸ”„ æŒä¹…åŒ–æµ‹è¯•</h4>
                    <p>è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æµ‹è¯•ï¼š</p>
                    <ol>
                        <li>åˆ‡æ¢å¼€å…³çŠ¶æ€</li>
                        <li>ç‚¹å‡»"ä¿å­˜å¼€å…³çŠ¶æ€"</li>
                        <li>åˆ·æ–°é¡µé¢ (Ctrl+F5)</li>
                        <li>ç‚¹å‡»"åŠ è½½å½“å‰é…ç½®"</li>
                        <li>æ£€æŸ¥å¼€å…³çŠ¶æ€æ˜¯å¦ä¸ä¿å­˜å‰ä¸€è‡´</li>
                    </ol>
                    <p><strong>å¦‚æœçŠ¶æ€ä¸€è‡´ï¼Œè¯´æ˜ä¿å­˜åŠŸèƒ½æ­£å¸¸å·¥ä½œï¼</strong></p>
                </div>
            `;
        }

        async function testConfigMerging() {
            const resultDiv = document.getElementById('merge-result');
            const domain = document.getElementById('testDomain').value.trim();
            
            if (!domain) {
                resultDiv.innerHTML = `
                    <div class="warning">
                        <h4>âš ï¸ è¯·è¾“å…¥æµ‹è¯•åŸŸå</h4>
                    </div>
                `;
                return;
            }
            
            resultDiv.innerHTML = '<p>æ­£åœ¨æµ‹è¯•é…ç½®åˆå¹¶...</p>';
            
            try {
                // æ¨¡æ‹Ÿé…ç½®åˆå¹¶æµ‹è¯•
                const toggle = document.getElementById('domainRulesToggle');
                const domainRulesEnabled = toggle.checked;
                
                resultDiv.innerHTML = `
                    <div class="info">
                        <h4>ğŸ“‹ é…ç½®åˆå¹¶æµ‹è¯•ç»“æœ</h4>
                        <p><strong>æµ‹è¯•åŸŸå:</strong> ${domain}</p>
                        <p><strong>åŸŸåè§„åˆ™å¼€å…³:</strong> ${domainRulesEnabled ? 'å¯ç”¨' : 'ç¦ç”¨'}</p>
                        <p><strong>é¢„æœŸè¡Œä¸º:</strong></p>
                        <ul>
                            <li>${domainRulesEnabled ? 'âœ… åº”è¯¥åº”ç”¨åŸŸåç‰¹å®šçš„é…ç½®è§„åˆ™' : 'âŒ åº”è¯¥å¿½ç•¥åŸŸåç‰¹å®šçš„é…ç½®è§„åˆ™'}</li>
                            <li>${domainRulesEnabled ? 'âœ… åŸŸåé…ç½®ä¼šè¦†ç›–å…¨å±€é…ç½®' : 'âŒ åªä½¿ç”¨å…¨å±€é…ç½®'}</li>
                        </ul>
                        <p><em>åœ¨å®é™…æ‰©å±•ä¸­ï¼Œè¿™ä¼šå½±å“å†…å®¹æå–æ—¶ä½¿ç”¨çš„é…ç½®ã€‚</em></p>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>âŒ æµ‹è¯•å¤±è´¥</h4>
                        <p>é”™è¯¯ä¿¡æ¯: ${error.message}</p>
                    </div>
                `;
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨åŠ è½½é…ç½®
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ”§ åŸŸåè§„åˆ™å¼€å…³æµ‹è¯•é¡µé¢å·²åŠ è½½');
            loadCurrentConfig();
        });
    </script>
</body>
</html>
